<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OpenWorks Admin</title>
<meta name="robots" content="noindex, nofollow">

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<style>
  :root{
    --bg:#f5f7fb; --panel:#f0f3f9; --card:#ffffff; --ink:#0e1116; --muted:#526170;
    --brand:#2e7d32; --brand-ink:#ffffff; --border:#e6ebf2; --danger:#b42318; --focus:#0ea5e9;
    --shadow:0 10px 30px rgba(18,38,63,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:20}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{width:34px;height:34px}
  .wrap{max-width:1300px;margin:0 auto;padding:16px 18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,select,button,textarea{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff0;color:inherit;font:inherit}
  button.btn{border:1px solid transparent;background:var(--brand);color:var(--brand-ink);font-weight:800;cursor:pointer;display:inline-block}
  button.btn.small{padding:6px 10px;border-radius:10px;font-size:.9rem}
  button.ghost{background:transparent;border-color:var(--border);cursor:pointer}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
  .alert{background:#fff;border:1px solid var(--danger);color:var(--danger);padding:10px 12px;border-radius:12px;margin-bottom:12px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th{font-size:.85rem;text-transform:uppercase;letter-spacing:.02em;color:var(--muted);text-align:left;padding:0 10px}
  td{background:var(--card);border:1px solid var(--border);padding:10px;border-left:none;border-right:none;vertical-align:top}
  tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px;border-left:1px solid var(--border)}
  tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px;border-right:1px solid var(--border)}
  tr[data-idx]{cursor:pointer}
  tr[data-idx]:hover td{background:#f8fafc}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:.85rem}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:.8rem}
  .toast{position:fixed;inset:auto 16px 16px auto;background:var(--card);border:1px solid var(--border);padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(8px);transition:.25s;z-index:200}
  .toast.show{opacity:1;transform:none}
  #map{height:360px;border-radius:14px}
  :focus-visible{outline:3px solid var(--focus);outline-offset:2px;border-radius:10px}
  a.inline{color:var(--brand);text-decoration:none;border-bottom:1px dashed var(--brand)}
  .dot{width:14px;height:14px;border-radius:50%;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.2)}
  .empty{display:flex;align-items:center;justify-content:center;height:240px;color:var(--muted)}
  /* Drawer */
  #drawer{position:fixed;inset:0 0 0 0;opacity:0;pointer-events:none;z-index:2147483647}
  #drawer.show{opacity:1;pointer-events:auto}
  #drawer_backdrop{position:absolute;inset:0;background:rgba(0,0,0,.28)}
  #drawer_panel{position:absolute;right:0;top:0;bottom:0;width:min(560px,100%);background:#fff;border-left:1px solid var(--border);box-shadow:var(--shadow);display:flex;flex-direction:column}
</style>
</head>
<body>
<header>
  <div class="brand">
    <img alt="Seal" src="https://upload.wikimedia.org/wikipedia/commons/2/27/Seal_of_Sutton%2C_Massachusetts.png?20231220025329">
    <strong>OpenWorks Admin</strong>
  </div>

  <!-- AUTH: Google button always visible in this container -->
  <div class="row" id="authRow">
    <div id="gsi" style="min-width:200px; min-height:40px; display:inline-block"></div>
    <span id="me" class="chip" style="display:none"></span>
    <button id="signout" class="ghost" style="display:none">Sign out</button>
  </div>
</header>

<div class="wrap">
  <section class="card">
    <div id="err" style="display:none" class="alert"></div>

    <div class="row" style="padding:6px 6px 12px 6px">
      <input id="q" aria-label="Search tickets" placeholder="Search description, address, reporter…" style="min-width:260px">
      <select id="qs" aria-label="Filter by status">
        <option value="">All statuses</option>
        <option>Open</option><option>In Progress</option><option>On Hold</option><option>Completed</option><option>Closed</option>
      </select>
      <select id="qc" aria-label="Filter by category">
        <option value="">All categories</option>
        <option value="roads_sidewalks">Roads &amp; Sidewalks</option>
        <option value="trees_row">Trees &amp; Vegetation (ROW)</option>
        <option value="signs_markings">Signs &amp; Markings</option>
        <option value="drainage_stormwater">Drainage &amp; Stormwater</option>
        <option value="snow_ice">Snow &amp; Ice</option>
        <option value="litter_dumping">Litter &amp; Illegal Dumping</option>
        <option value="facilities_grounds">Facilities &amp; Grounds</option>
        <option value="sewer">Sewer (routing)</option>
      </select>
      <button class="btn" id="refresh" type="button">Refresh</button>
      <span class="badge" id="count" style="margin-left:auto">—</span>
    </div>

    <div id="map" role="region" aria-label="Open & In Progress map"></div>

    <div id="empty" class="empty" style="display:none">Sign in to load tickets.</div>

    <table style="margin-top:12px">
      <thead>
        <tr><th>Ticket</th><th>Status</th><th>Category</th><th>Description</th><th>Address</th><th>Reporter</th><th>Updated</th><th></th></tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </section>
</div>

<!-- Drawer -->
<div id="drawer" aria-hidden="true">
  <div id="drawer_backdrop"></div>
  <div id="drawer_panel">
    <header style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#f0f3f9;border-bottom:1px solid #e6ebf2">
      <strong id="d_title">Ticket</strong>
      <button id="close" class="ghost" type="button">Close</button>
    </header>
    <div class="content" style="padding:14px;overflow:auto;display:flex;flex-direction:column;gap:12px;height:calc(100% - 56px)">
      <div class="row" style="gap:12px; flex-wrap:wrap">
        <div><div class="muted">Ticket</div><div id="d_tid" class="badge"></div></div>
        <div>
          <label class="muted" for="d_status">Status</label>
          <select id="d_status">
            <option>Open</option><option>In Progress</option><option>On Hold</option><option>Completed</option><option>Closed</option>
          </select>
        </div>
        <div>
          <label class="muted" for="d_assigned">Assign to</label>
          <input id="d_assigned" placeholder="name or email">
        </div>
      </div>

      <div class="row" style="gap:16px; flex-wrap:wrap">
        <div><div class="muted">Category</div><div id="d_cat"></div></div>
        <div><div class="muted">Priority</div><div id="d_prio"></div></div>
        <div><div class="muted">Updated</div><div id="d_updated"></div></div>
      </div>

      <div style="margin-top:6px">
        <div class="muted">Address</div>
        <div id="d_addr"></div>
      </div>

      <div style="margin-top:6px">
        <div class="muted">Description</div>
        <div id="d_desc"></div>
      </div>

      <hr style="border:none;border-top:1px solid var(--border)">

      <div class="card" style="padding:12px">
        <strong>Requestor</strong>
        <div class="row" style="gap:16px; flex-wrap:wrap; margin-top:6px">
          <div><div class="muted">Name</div><div id="d_rname"></div></div>
          <div><div class="muted">Email</div><div><a id="d_remail" class="inline" href="#"></a></div></div>
          <div><div class="muted">Phone</div><div id="d_rphone"></div></div>
        </div>
      </div>

      <div class="card" style="padding:12px">
        <strong>Timeline</strong>
        <div id="timeline" style="display:flex;flex-direction:column;gap:10px;margin-top:8px"></div>
      </div>

      <div class="card" style="padding:12px">
        <strong>Add Note / Update</strong>
        <p class="muted" style="margin:.4rem 0 1rem">Internal notes are visible to staff only. Public updates may be emailed to the resident.</p>

        <div style="display:grid; gap:14px; grid-template-columns:1fr 1fr; align-items:start">
          <div>
            <label for="n_staff"><b>Internal note (staff only)</b></label>
            <textarea id="n_staff" placeholder="e.g., Called contractor; scheduled for next week" style="width:100%;min-height:96px"></textarea>
          </div>

          <div>
            <label for="n_public"><b>Public update</b></label>
            <textarea id="n_public" placeholder="e.g., Crew dispatched; expect repair within 48 hours" style="width:100%;min-height:96px"></textarea>
            <label class="row" style="margin-top:6px"><input type="checkbox" id="n_email"> Email resident this public update</label>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="post" type="button">Post update</button>
          <span class="badge" id="post_spin" style="display:none">Posting…</span>
          <span id="post_msg" class="muted"></span>
        </div>
      </div>

      <div class="row">
        <button class="btn" id="save" type="button">Save changes</button>
        <span class="badge" id="save_spin" style="display:none">Saving…</span>
        <span id="save_msg" class="muted"></span>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===== Config ===== */
const API = 'https://script.google.com/macros/s/AKfycbwgL8hpjAivoSEvDYE61lrLbw8FkBKcylJZxK-e17456wFFDWsaKhqxkFXQzCioujA/exec';
const CLIENT_ID = '1053304257177-58btmvppdko26jhe3j70959e0gnodivt.apps.googleusercontent.com';
const TOK_KEY = 'ow_id_token';

let idToken=null, dataset=[], current=null;

/* ===== Helpers ===== */
const $ = (s)=>document.querySelector(s);
function toast(m){ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); }
function fmtDT(x){ if(!x) return ''; const d=new Date(x); return isNaN(d)? String(x): d.toLocaleString(undefined,{dateStyle:'medium',timeStyle:'short'}); }
function showError(msg){ const e=$('#err'); e.textContent=msg; e.style.display='block'; }
function clearError(){ const e=$('#err'); e.textContent=''; e.style.display='none'; }
function openDrawer(){ const d=$('#drawer'); d.classList.add('show'); d.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
function closeDrawer(){ const d=$('#drawer'); d.classList.remove('show'); d.setAttribute('aria-hidden','true'); document.body.style.overflow=''; current=null; }

function setToken(tok){ idToken=tok; try{ localStorage.setItem(TOK_KEY, tok||''); }catch(_){} }
function getSavedToken(){ try{ return localStorage.getItem(TOK_KEY)||''; }catch(_){ return ''; }
function decodeEmailFromToken(tok){ try{ return JSON.parse(atob(tok.split('.')[1].replace(/-/g,'+').replace(/_/g,'/'))).email || ''; } catch { return ''; } }

/* ===== Filters ===== */
['q','qs','qc'].forEach(id=>{
  const el = document.getElementById(id);
  el.addEventListener('change', refresh);
  if(id==='q'){ el.addEventListener('keyup', e=>{ if(e.key==='Enter') refresh(); }); }
});

/* ===== Normalize row ===== */
function normalizeRow(r){
  const id = r.ticket_id || r.id || r.TicketID || r['Ticket ID'] || r['Ticket Id'];
  return {
    ticket_id: String(id||'').trim(),
    status: r.status || r.Status || '',
    category: r.category_label || r.category || r.Category || '',
    description: r.description || r.Description || '',
    address: r.address || r.Address || '',
    lat: r.lat || r.latitude || r.Lat || r.Latitude || '',
    lng: r.lng || r.lon || r.long || r.Lng || r.Longitude || '',
    reporter_name: r.reporter_name || r.Name || r.Reporter || r['Reporter Name'] || '',
    reporter_email: r.reporter_email || r.Email || r['Reporter Email'] || '',
    reporter_phone: r.reporter_phone || r.Phone || r['Reporter Phone'] || '',
    priority_hint: r.priority_hint || r.Priority || 'normal',
    assigned_to: r.assigned_to || r.Assigned || r['Assigned To'] || '',
    last_updated_at: r.last_updated_at || r.updated_at || r.Updated || r['Last Updated'] || '',
    timestamp: r.timestamp || r.created_at || r.Created || r['Created At'] || ''
  };
}

/* ===== Global open helpers ===== */
window.OW = {
  openByIdx: async function(idx){
    if(!Array.isArray(dataset) || dataset.length===0){ await refresh(); }
    if(!Array.isArray(dataset) || dataset.length===0){ return; }
    if(idx == null || isNaN(idx)) idx = 0;
    if(idx < 0 || idx >= dataset.length){ toast(`Row ${idx} out of range`); return; }
    await openTicketByIndex(idx);
  },
  rows: () => (dataset||[])
};

/* ===== Table render ===== */
function renderRows(list){
  const tb=$('#rows'); tb.innerHTML='';
  $('#count').textContent = Number.isFinite(list.length) ? `${list.length} ticket${list.length===1?'':'s'}` : '—';
  if(!list.length){ $('#empty').style.display = 'block'; return; }
  $('#empty').style.display='none';

  list.forEach((r, idx)=>{
    const tr=document.createElement('tr');
    tr.setAttribute('data-idx', idx);
    tr.innerHTML=`
      <td><b>${r.ticket_id || '(no id)'}</b><div class="muted" style="font-size:.85rem">${r.priority_hint||'normal'}</div></td>
      <td><span class="pill">${r.status||''}</span></td>
      <td>${r.category||''}</td>
      <td>${(r.description||'').slice(0,120)}</td>
      <td>${displayAddress(r)}</td>
      <td>${r.reporter_name||''}<div class="muted" style="font-size:.85rem">${r.reporter_email||''}</div></td>
      <td>${fmtDT(r.last_updated_at || r.timestamp)}</td>
      <td><button type="button" class="btn small open" data-idx="${idx}" onclick="OW.openByIdx(${idx});return false;">Open</button></td>`;
    tb.appendChild(tr);
  });
}
document.getElementById('rows').addEventListener('click', (e)=>{
  const row = e.target.closest('tr[data-idx]');
  if(row && !e.target.closest('button')){ e.preventDefault(); OW.openByIdx(parseInt(row.dataset.idx,10)); }
});

/* ===== Address display (fallback to Sutton) ===== */
function displayAddress(r){
  if(r.address && /sutton/i.test(r.address)) return r.address;
  if(r.address) return `${r.address}, Sutton, MA 01590`;
  if(r.lat && r.lng) return `${r.lat}, ${r.lng}`;
  return '—';
}

/* ===== Open ticket (drawer) ===== */
async function openTicketByIndex(idx){
  const row = dataset[idx]; if(!row) return;
  current = row;

  $('#d_title').textContent = `Ticket ${row.ticket_id || ''}`;
  $('#d_tid').textContent = row.ticket_id || '(no id)';
  $('#d_status').value = row.status || 'Open';
  $('#d_assigned').value = row.assigned_to || '';
  $('#d_cat').textContent = row.category || '';
  $('#d_prio').textContent = row.priority_hint || 'normal';
  $('#d_updated').textContent = fmtDT(row.last_updated_at || row.timestamp);
  $('#d_addr').textContent = displayAddress(row);
  $('#d_desc').textContent = row.description || '';

  $('#d_rname').textContent = row.reporter_name || '—';
  const em = row.reporter_email || '';
  const a = $('#d_remail'); a.textContent = em || '—'; a.href = em ? `mailto:${em}` : '#';
  $('#d_rphone').textContent = row.reporter_phone || '—';

  openDrawer();
  const tbox = document.getElementById('timeline');
  tbox.innerHTML = '<div class="muted">Loading timeline…</div>';
  loadTimeline(row.ticket_id || '');
}

/* ===== Load data ===== */
async function refresh(){
  clearError();
  if(!idToken){
    $('#empty').style.display='block';
    $('#count').textContent='—';
    $('#rows').innerHTML='';
    return;
  }
  const q=$('#q').value.trim(), qs=$('#qs').value, qc=$('#qc').value;
  try{
    const res = await fetch(API, {
      method:'POST', headers:{'Content-Type':'text/plain'},
      body: JSON.stringify({ action:'admin_list', id_token:idToken, filters:{ q, status:qs, category:qc } })
    });
    const text = await res.text();
    let data = {}; try{ data = JSON.parse(text); }catch{ showError('Admin API returned non-JSON'); return; }
    if(data.ok){
      dataset=(data.rows||[]).map(normalizeRow);
      renderRows(dataset);
      ensureMap(); plotMap();
    }else{
      showError(data.error || 'Load failed');
      $('#rows').innerHTML=''; $('#count').textContent='—'; $('#empty').style.display='block';
    }
  }catch(err){
    console.error(err);
    showError('Network error loading tickets');
  }
}
document.getElementById('refresh').addEventListener('click', refresh);

/* ===== Timeline ===== */
async function loadTimeline(tid){
  try{
    const res=await fetch(API,{method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify({action:'admin_activity', id_token:idToken, ticket_id: tid})});
    const data=await res.json();
    const box=$('#timeline'); box.innerHTML='';
    if(!data.ok){ box.textContent='Could not load timeline'; return; }
    (data.rows||[]).forEach(evt=>{
      const div=document.createElement('div');
      div.style.border='1px solid var(--border)';
      div.style.borderRadius='12px';
      div.style.padding='10px';
      const parts=[];
      if(evt.status) parts.push(`Status: ${evt.status}`);
      if(evt.assigned_to) parts.push(`Assigned to: ${evt.assigned_to}`);
      div.innerHTML=`
        <div class="row" style="justify-content:space-between">
          <div><b>${evt.action}</b> • <span class="muted">${evt.actor||''}</span></div>
          <div class="muted">${fmtDT(evt.timestamp)}</div>
        </div>
        ${parts.length?(`<div class="muted" style="margin-top:6px">${parts.join(' • ')}</div>`):''}
        ${evt.public_update?(`<div style="margin-top:6px"><b>Public update</b><div>${evt.public_update}</div></div>`):''}
        ${evt.staff_note?(`<div style="margin-top:6px"><b>Staff note</b><div>${evt.staff_note}</div></div>`):''}
        ${evt.emailed_resident?(`<div class="muted" style="margin-top:6px">Resident emailed ✓</div>`):''}
      `;
      box.appendChild(div);
    });
  }catch(err){ $('#timeline').textContent = 'Timeline failed to load.'; }
}

/* ===== Save + Post ===== */
document.getElementById('save').addEventListener('click', async ()=>{
  if(!current) return;
  const update = {
    ticket_id: current.ticket_id,
    status: document.getElementById('d_status').value,
    assigned_to: document.getElementById('d_assigned').value.trim(),
    staff_notes: '', public_update: '', email_resident: false
  };
  document.getElementById('save_spin').style.display='inline-flex'; document.getElementById('save_msg').textContent='';
  const res=await fetch(API,{method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify({action:'admin_update', id_token:idToken, update})});
  const data=await res.json(); document.getElementById('save_spin').style.display='none';
  if(data.ok){ toast('Saved ✓'); await refresh(); if(current){ const idx = dataset.findIndex(r=>r.ticket_id===current.ticket_id); if(idx>-1) openTicketByIndex(idx); } }
  else document.getElementById('save_msg').textContent = data.error||'Save failed';
});
document.getElementById('post').addEventListener('click', async ()=>{
  if(!current) return;
  const update={
    ticket_id: current.ticket_id,
    status: document.getElementById('d_status').value,
    assigned_to: document.getElementById('d_assigned').value.trim(),
    staff_notes: document.getElementById('n_staff').value.trim(),
    public_update: document.getElementById('n_public').value.trim(),
    email_resident: document.getElementById('n_email').checked
  };
  if(!update.staff_notes && !update.public_update && !update.email_resident){
    document.getElementById('post_msg').textContent='Enter a note or update.'; return;
  }
  document.getElementById('post_spin').style.display='inline-flex'; document.getElementById('post_msg').textContent='';
  const res=await fetch(API,{method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify({action:'admin_update', id_token:idToken, update})});
  const data=await res.json(); document.getElementById('post_spin').style.display='none';
  if(data.ok){
    document.getElementById('n_staff').value=''; document.getElementById('n_public').value=''; document.getElementById('n_email').checked=false;
    toast('Posted ✓'); await refresh(); if(current){ const idx = dataset.findIndex(r=>r.ticket_id===current.ticket_id); if(idx>-1) openTicketByIndex(idx); }
  }else document.getElementById('post_msg').textContent=data.error||'Post failed';
});

/* ===== Drawer controls ===== */
document.getElementById('close').addEventListener('click', closeDrawer);
document.getElementById('drawer_backdrop').addEventListener('click', closeDrawer);

/* ===== Map + Geocoding ===== */
let map, mapReady=false, markersLayer, geocodeCache=new Map();
function ensureMap(){
  if(mapReady) return;
  map = L.map('map', { scrollWheelZoom:true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
  map.setView([42.1501,-71.7637], 12);
  mapReady = true;
}
function colorForStatus(s){
  s=String(s||'').toLowerCase();
  if(s==='open') return '#d32f2f';
  if(s==='in progress') return '#f59f00';
  if(s==='on hold') return '#868e96';
  if(s==='completed') return '#2e7d32';
  if(s==='closed') return '#334155';
  return '#666';
}
function dotIcon(color){ return L.divIcon({ className:'', html:`<div class="dot" style="background:${color}"></div>`, iconSize:[16,16], iconAnchor:[8,8], popupAnchor:[0,-8] }); }
function assumedFullAddress(addr){ if(!addr) return ''; if(/sutton/i.test(addr)) return addr; return `${addr}, Sutton, MA 01590`; }
async function geocodeAddress(addr){
  const q = assumedFullAddress(addr); if(!q) return null;
  if(geocodeCache.has(q)) return geocodeCache.get(q);
  try{
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
    const res = await fetch(url, { headers:{'Accept':'application/json'} });
    const data = await res.json();
    const pt = (Array.isArray(data) && data[0]) ? {lat:+data[0].lat, lng:+data[0].lon} : null;
    geocodeCache.set(q, pt); return pt;
  }catch(_){ return null; }
}
async function plotMap(){
  if(!mapReady) return;
  markersLayer.clearLayers();
  const tasks = [];
  for(let idx=0; idx<dataset.length; idx++){
    const r = dataset[idx];
    if(!/^(Open|In Progress)$/i.test(String(r.status||''))) continue;
    if(r.lat && r.lng){
      tasks.push(Promise.resolve({idx, r, lat:parseFloat(r.lat), lng:parseFloat(r.lng)}));
    }else if(r.address){
      tasks.push(geocodeAddress(r.address).then(pt => pt ? ({idx, r, lat:pt.lat, lng:pt.lng}) : null));
    }
  }
  const pts = (await Promise.all(tasks)).filter(Boolean);
  pts.forEach(({idx, r, lat, lng})=>{
    const m = L.marker([lat,lng], { icon: dotIcon(colorForStatus(r.status)) });
    const safeAddr = (displayAddress(r)||'').replace(/</g,'&lt;');
    m.bindPopup(`
      <b>${r.ticket_id || '(no id)'}</b><br>
      ${r.status || ''} • ${r.category || ''}<br>
      ${safeAddr}<br>
      <button type="button" data-idx="${idx}" style="margin-top:6px;padding:6px 10px;border-radius:8px;border:1px solid #e6ebf2;background:#fff0;cursor:pointer" onclick="OW.openByIdx(${idx});return false;">Open</button>
    `);
    m.on('click', ()=> OW.openByIdx(idx));
    markersLayer.addLayer(m);
  });
  try{
    if(pts.length){ const b = L.latLngBounds(pts.map(x=>[x.lat, x.lng])); map.fitBounds(b, {padding:[24,24]}); }
    else { map.setView([42.1501,-71.7637], 12); }
  }catch(_){}
}

/* ===== Auth UI (Google button always visible) ===== */
function renderAuthUI(){
  const email = idToken ? decodeEmailFromToken(idToken) : '';
  const me = document.getElementById('me');
  const signout = document.getElementById('signout');
  if(email){
    me.textContent = `Signed in as ${email}`;
    me.style.display='inline-flex';
    signout.style.display='inline-block';
    document.getElementById('empty').textContent='No tickets match your filters.';
  }else{
    me.style.display='none';
    signout.style.display='none';
    document.getElementById('empty').textContent='Sign in to load tickets.';
  }
}
document.getElementById('signout').addEventListener('click', ()=>{
  setToken(''); renderAuthUI();
  document.getElementById('rows').innerHTML=''; document.getElementById('count').textContent='—'; document.getElementById('empty').style.display='block';
});

/* Initialize GSI and render button ASAP, keep container visible always */
function initGSI(){
  if(!(window.google && google.accounts && google.accounts.id)){
    setTimeout(initGSI, 150); return;
  }
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: (resp)=>{ setToken(resp.credential); renderAuthUI(); refresh().then(()=>{ensureMap(); plotMap();}); }
  });
  const gsiEl = document.getElementById('gsi');
  gsiEl.innerHTML = ''; // ensure clean mount
  google.accounts.id.renderButton(gsiEl, { theme:'outline', size:'large' });

  // If a token already exists, use it (button remains visible)
  const saved = getSavedToken();
  if(saved){ setToken(saved); renderAuthUI(); refresh().then(()=>{ensureMap(); plotMap();}); }
}

/* Boot */
window.addEventListener('DOMContentLoaded', ()=>{
  const saved = getSavedToken();
  if(saved) setToken(saved);
  renderAuthUI();
  initGSI();
});
</script>
</body>
</html>
