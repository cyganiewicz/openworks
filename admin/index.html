<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OpenWorks Admin</title>
<meta name="robots" content="noindex, nofollow">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
<style>
  :root{
    --bg:#f5f7fb; --panel:#f0f3f9; --card:#ffffff; --ink:#0e1116; --muted:#526170; --brand:#2e7d32; --brand-ink:#ffffff; --border:#e6ebf2; --danger:#c92a2a; --focus:#0ea5e9; --shadow:0 10px 30px rgba(18, 38, 63, .08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:20}
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{width:34px;height:34px}
  .wrap{max-width:1300px;margin:0 auto;padding:16px 18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,select,button,textarea{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff0;color:inherit;font:inherit}
  button.btn{border:1px solid transparent;background:var(--brand);color:var(--brand-ink);font-weight:800;cursor:pointer}
  button.ghost{background:transparent;border-color:var(--border)}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th{font-size:.85rem;text-transform:uppercase;letter-spacing:.02em;color:var(--muted);text-align:left;padding:0 10px}
  td{background:var(--card);border:1px solid var(--border);padding:10px;border-left:none;border-right:none}
  tr td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px;border-left:1px solid var(--border)}
  tr td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px;border-right:1px solid var(--border)}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:.85rem}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:.8rem}
  .toast{position:fixed;inset:auto 16px 16px auto;background:var(--card);border:1px solid var(--border);padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(8px);transition:.25s;z-index:50}
  .toast.show{opacity:1;transform:none}
  /* Drawer */
  .drawer{position:fixed;inset:0 0 0 auto;display:none;z-index:40}
  .drawer.open{display:block}
  .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.25)}
  .panel{position:absolute;right:0;top:0;bottom:0;width:min(560px,100%);background:var(--card);border-left:1px solid var(--border);box-shadow:var(--shadow);display:flex;flex-direction:column}
  .panel header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--panel);border-bottom:1px solid var(--border)}
  .panel .content{padding:14px;overflow:auto;display:flex;flex-direction:column;gap:12px}
  textarea{min-height:84px}
  #map{height:360px;border-radius:14px}
  :focus-visible{outline:3px solid var(--focus);outline-offset:2px;border-radius:10px}
  a.inline{color:var(--brand);text-decoration:none;border-bottom:1px dashed var(--brand)}
</style>
</head>
<body>
<header>
  <div class="brand">
    <img alt="Seal" src="https://upload.wikimedia.org/wikipedia/commons/2/27/Seal_of_Sutton%2C_Massachusetts.png?20231220025329">
    <strong>OpenWorks Admin</strong>
  </div>
  <div class="row">
    <div id="gsi"></div>
    <span id="me" class="muted"></span>
  </div>
</header>

<div class="wrap">
  <section class="card">
    <div class="row" style="padding:6px 6px 12px 6px">
      <input id="q" placeholder="Search description, address, reporter…" style="min-width:260px">
      <select id="qs">
        <option value="">All statuses</option>
        <option>Open</option><option>In Progress</option><option>On Hold</option><option>Completed</option><option>Closed</option>
      </select>
      <select id="qc">
        <option value="">All categories</option>
        <option value="roads_sidewalks">Roads &amp; Sidewalks</option>
        <option value="trees_row">Trees &amp; Vegetation (ROW)</option>
        <option value="signs_markings">Signs &amp; Markings</option>
        <option value="drainage_stormwater">Drainage &amp; Stormwater</option>
        <option value="snow_ice">Snow &amp; Ice</option>
        <option value="litter_dumping">Litter &amp; Illegal Dumping</option>
        <option value="facilities_grounds">Facilities &amp; Grounds</option>
        <option value="sewer">Sewer (routing)</option>
      </select>
      <button class="btn" id="refresh">Refresh</button>
      <span class="badge" id="count" style="margin-left:auto">0 tickets</span>
    </div>

    <!-- Embedded map on the tickets page -->
    <div id="map" role="region" aria-label="Open & In Progress map"></div>

    <table style="margin-top:12px">
      <thead>
        <tr><th>Ticket</th><th>Status</th><th>Category</th><th>Description</th><th>Address</th><th>Reporter</th><th>Updated</th><th></th></tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </section>
</div>

<!-- Right-hand drawer (detail) -->
<div class="drawer" id="drawer" aria-hidden="true">
  <div class="backdrop" id="backdrop"></div>
  <div class="panel">
    <header>
      <strong id="d_title">Ticket</strong>
      <button id="close" class="ghost">Close</button>
    </header>
    <div class="content">
      <div class="row" style="gap:12px; flex-wrap:wrap">
        <div><div class="muted">Ticket</div><div id="d_tid" class="badge"></div></div>
        <div><div class="muted">Status</div>
          <select id="d_status">
            <option>Open</option><option>In Progress</option><option>On Hold</option><option>Completed</option><option>Closed</option>
          </select>
        </div>
        <div><div class="muted">Assign to</div><input id="d_assigned" placeholder="name or email"></div>
      </div>

      <div class="row" style="gap:16px; flex-wrap:wrap">
        <div><div class="muted">Category</div><div id="d_cat"></div></div>
        <div><div class="muted">Priority</div><div id="d_prio"></div></div>
        <div><div class="muted">Updated</div><div id="d_updated"></div></div>
      </div>

      <div style="margin-top:6px">
        <div class="muted">Address</div>
        <div id="d_addr"></div>
      </div>

      <div style="margin-top:6px">
        <div class="muted">Description</div>
        <div id="d_desc"></div>
      </div>

      <hr style="border:none;border-top:1px solid var(--border)">

      <div class="card" style="padding:12px">
        <strong>Requestor</strong>
        <div class="row" style="gap:16px; flex-wrap:wrap; margin-top:6px">
          <div><div class="muted">Name</div><div id="d_rname"></div></div>
          <div><div class="muted">Email</div><div><a id="d_remail" class="inline" href="#"></a></div></div>
          <div><div class="muted">Phone</div><div id="d_rphone"></div></div>
        </div>
      </div>

      <div class="card" style="padding:12px">
        <strong>Timeline</strong>
        <div id="timeline" style="display:flex;flex-direction:column;gap:10px;margin-top:8px"></div>
      </div>

      <div class="card" style="padding:12px">
        <strong>Add Note / Update</strong>
        <div class="hint">Internal notes are visible to staff only. Public updates can be emailed to the resident.</div>
        <label style="margin-top:8px">Internal note (staff only)</label>
        <textarea id="n_staff" placeholder="e.g., Called contractor; scheduled for next week"></textarea>
        <label>Public update</label>
        <textarea id="n_public" placeholder="e.g., Crew dispatched; expect repair within 48 hours"></textarea>
        <label class="row"><input type="checkbox" id="n_email"> Email resident this public update</label>
        <div class="row">
          <button class="btn" id="post">Post update</button>
          <span class="badge" id="post_spin" style="display:none">Posting…</span>
          <span id="post_msg" class="muted"></span>
        </div>
      </div>

      <div class="row">
        <button class="btn" id="save">Save changes</button>
        <span class="badge" id="save_spin" style="display:none">Saving…</span>
        <span id="save_msg" class="muted"></span>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbwgL8hpjAivoSEvDYE61lrLbw8FkBKcylJZxK-e17456wFFDWsaKhqxkFXQzCioujA/exec';
const CLIENT_ID = '1053304257177-58btmvppdko26jhe3j70959e0gnodivt.apps.googleusercontent.com';
let idToken=null, dataset=[], current=null;

// --- helpers ---
const $ = (s)=>document.querySelector(s);
function toast(m){ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); }
function openDrawer(){ const d=$('#drawer'); d.classList.add('open'); d.setAttribute('aria-hidden','false'); }
function closeDrawer(){ const d=$('#drawer'); d.classList.remove('open'); d.setAttribute('aria-hidden','true'); current=null; }

// persist token
const TOK_KEY='ow_id_token';
function setToken(tok){ idToken=tok; try{ localStorage.setItem(TOK_KEY, tok || ''); }catch(_){} }
function getSavedToken(){ try{ return localStorage.getItem(TOK_KEY)||''; }catch(_){ return ''; } }

// auto-filter refresh
['q','qs','qc'].forEach(id=>{
  document.getElementById(id).addEventListener('change', ()=> refresh());
  if(id==='q'){ document.getElementById(id).addEventListener('keyup', e=>{ if(e.key==='Enter') refresh(); }); }
});

// --- table ---
function renderRows(list){
  const tb=$('#rows'); tb.innerHTML='';
  $('#count').textContent=`${list.length} ticket${list.length===1?'':'s'}`;
  list.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><b>${r.ticket_id}</b><div class="muted" style="font-size:.85rem">${r.priority_hint||'normal'}</div></td>
      <td><span class="pill">${r.status||''}</span></td>
      <td>${r.category||''}</td>
      <td>${(r.description||'').slice(0,120)}</td>
      <td>${displayAddress(r)}</td>
      <td>${r.reporter_name||''}<div class="muted" style="font-size:.85rem">${r.reporter_email||''}</div></td>
      <td>${r.last_updated_at || r.timestamp || ''}</td>
      <td><button class="ghost view" data-id="${r.ticket_id}">Open</button></td>`;
    tb.appendChild(tr);
  });
  // robust event binding
  tb.querySelectorAll('button.view').forEach(b=> b.addEventListener('click', (ev)=>{ ev.stopPropagation(); openTicket(b.getAttribute('data-id')); }));
}

// assume Sutton, MA if not in address
function displayAddress(r){
  if(r.address && /sutton/i.test(r.address)) return r.address;
  if(r.address) return `${r.address}, Sutton, MA 01590`;
  if(r.lat && r.lng) return `${r.lat}, ${r.lng}`;
  return '—';
}

// --- load + show ticket ---
async function openTicket(tid){
  current = dataset.find(x=>x.ticket_id===tid);
  if(!current){ toast('Ticket not found'); return; }
  $('#d_title').textContent = 'Ticket';
  $('#d_tid').textContent = current.ticket_id;
  $('#d_status').value = current.status || 'Open';
  $('#d_assigned').value = current.assigned_to || '';
  $('#d_cat').textContent = current.category || '';
  $('#d_prio').textContent = current.priority_hint || 'normal';
  $('#d_updated').textContent = current.last_updated_at || current.timestamp || '';
  $('#d_addr').textContent = displayAddress(current);
  $('#d_desc').textContent = current.description || '';

  // Requestor
  $('#d_rname').textContent = current.reporter_name || '—';
  const em = (current.reporter_email||'');
  $('#d_remail').textContent = em || '—';
  $('#d_remail').href = em ? `mailto:${em}` : '#';
  $('#d_rphone').textContent = current.reporter_phone || '—';

  await loadTimeline(current.ticket_id);
  openDrawer();
}

// --- fetch list ---
async function refresh(){
  if(!idToken){ toast('Please sign in'); return; }
  const q=$('#q').value.trim(), qs=$('#qs').value, qc=$('#qc').value;
  const res = await fetch(API, {
    method:'POST', headers:{'Content-Type':'text/plain'},
    body: JSON.stringify({ action:'admin_list', id_token:idToken, filters:{ q, status:qs, category:qc } })
  });
  const data = await res.json();
  if(data.ok){
    dataset=data.rows;
    renderRows(dataset);
    ensureMap(); plotMap(); // update map on every refresh
  } else {
    // If unauthorized, clear token and prompt sign-in again once
    if((data.error||'').toLowerCase().includes('unauthorized')){ setToken(''); google.accounts.id.prompt(); }
    toast('Error: '+(data.error||'load failed'));
  }
}
document.getElementById('refresh').addEventListener('click', refresh);

// --- timeline ---
async function loadTimeline(tid){
  const res=await fetch(API,{method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify({action:'admin_activity', id_token:idToken, ticket_id: tid})});
  const data=await res.json();
  const box=$('#timeline'); box.innerHTML='';
  if(!data.ok){ box.textContent='Could not load timeline'; return; }
  data.rows.forEach(evt=>{
    const div=document.createElement('div');
    div.style.border='1px solid var(--border)'; div.style.borderRadius='12px'; div.style.padding='10px';
    div.innerHTML=`
      <div class="row" style="justify-content:space-between">
        <div><b>${evt.action}</b> • <span class="muted">${evt.actor||''}</span></div>
        <div class="muted">${evt.timestamp||''}</div>
      </div>
      ${evt.status?(`<div class="muted" style="margin-top:6px">Status: ${evt.status}</div>`):''}
      ${evt.public_update?(`<div style="margin-top:6px"><b>Public update</b><div>${evt.public_update}</div></div>`):''}
      ${evt.staff_note?(`<div style="margin-top:6px"><b>Staff note</b><div>${evt.staff_note}</div></div>`):''}
      ${evt.emailed_resident?(`<div class="muted" style="margin-top:6px">Resident emailed ✓</div>`):''}
    `;
    box.appendChild(div);
  });
}

// --- save ---
document.getElementById('save').addEventListener('click', async ()=>{
  if(!current) return;
  const update = {
    ticket_id: current.ticket_id,
    status: document.getElementById('d_status').value,
    assigned_to: document.getElementById('d_assigned').value.trim(),
    staff_notes: '', public_update: '', email_resident: false
  };
  document.getElementById('save_spin').style.display='inline-flex'; document.getElementById('save_msg').textContent='';
  const res=await fetch(API,{method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify({action:'admin_update', id_token:idToken, update})});
  const data=await res.json(); document.getElementById('save_spin').style.display='none';
  if(data.ok){ toast('Saved ✓'); await refresh(); if(current) await openTicket(current.ticket_id); }
  else document.getElementById('save_msg').textContent = data.error||'Save failed';
});

// --- post note/update ---
document.getElementById('post').addEventListener('click', async ()=>{
  if(!current) return;
  const update={
    ticket_id: current.ticket_id,
    status: document.getElementById('d_status').value,
    assigned_to: document.getElementById('d_assigned').value.trim(),
    staff_notes: document.getElementById('n_staff').value.trim(),
    public_update: document.getElementById('n_public').value.trim(),
    email_resident: document.getElementById('n_email').checked
  };
  if(!update.staff_notes && !update.public_update && !update.email_resident){ document.getElementById('post_msg').textContent='Enter a note or update.'; return; }
  document.getElementById('post_spin').style.display='inline-flex'; document.getElementById('post_msg').textContent='';
  const res=await fetch(API,{method:'POST', headers:{'Content-Type':'text/plain'}, body:JSON.stringify({action:'admin_update', id_token:idToken, update})});
  const data=await res.json(); document.getElementById('post_spin').style.display='none';
  if(data.ok){
    document.getElementById('n_staff').value=''; document.getElementById('n_public').value=''; document.getElementById('n_email').checked=false;
    toast('Posted ✓'); await refresh(); if(current) await openTicket(current.ticket_id);
  }else document.getElementById('post_msg').textContent=data.error||'Post failed';
});

// --- drawer controls ---
document.getElementById('close').addEventListener('click', closeDrawer);
document.getElementById('backdrop').addEventListener('click', closeDrawer);

// --- map (Leaflet) in the tickets page ---
let map, mapReady=false, markersLayer, geocodeCache=new Map();
function ensureMap(){
  if(mapReady) return;
  map = L.map('map', { scrollWheelZoom:true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
  map.setView([42.1501,-71.7637], 12); // Sutton, MA area
  mapReady = true;
}
function assumedFullAddress(addr){
  if(!addr) return '';
  if(/sutton/i.test(addr)) return addr;
  return `${addr}, Sutton, MA 01590`;
}
async function geocodeAddress(addr){
  const q = assumedFullAddress(addr);
  if(!q) return null;
  if(geocodeCache.has(q)) return geocodeCache.get(q);
  try{
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
    const res = await fetch(url, { headers:{'Accept':'application/json'}, method:'GET' });
    const data = await res.json();
    const pt = (Array.isArray(data) && data[0]) ? {lat:+data[0].lat, lng:+data[0].lon} : null;
    geocodeCache.set(q, pt);
    return pt;
  }catch(_){ return null; }
}
async function plotMap(){
  if(!mapReady) return;
  markersLayer.clearLayers();

  // Collect points for Open & In Progress
  const needed = [];
  for(const r of dataset){
    if(!['Open','In Progress'].includes(String(r.status))) continue;
    if(r.lat && r.lng){
      needed.push({r, lat:parseFloat(r.lat), lng:parseFloat(r.lng)});
    }else if(r.address){
      needed.push({r, addr:r.address}); // we'll try geocoding
    }
  }

  // Geocode any missing
  for(let i=0;i<needed.length;i++){
    if(needed[i].lat!=null) continue;
    const pt = await geocodeAddress(needed[i].addr);
    if(pt){ needed[i].lat=pt.lat; needed[i].lng=pt.lng; }
  }

  const pts = needed.filter(x=>x.lat!=null && x.lng!=null);
  pts.forEach(({r,lat,lng})=>{
    const m = L.marker([lat,lng]);
    const safeAddr = (displayAddress(r)||'').replace(/</g,'&lt;');
    m.bindPopup(`
      <b>${r.ticket_id}</b><br>
      ${r.status || ''} • ${r.category || ''}<br>
      ${safeAddr}<br>
      <button data-open="${r.ticket_id}" style="margin-top:6px;padding:6px 10px;border-radius:8px;border:1px solid #e6ebf2;background:#fff0;cursor:pointer">Open</button>
    `);
    m.on('popupopen', e=>{
      const btn = e.popup.getElement().querySelector('button[data-open]');
      if(btn){ btn.addEventListener('click', ()=> { openTicket(btn.getAttribute('data-open')); map.closePopup(); }); }
    });
    markersLayer.addLayer(m);
  });

  try{
    if(pts.length){ const b = L.latLngBounds(pts.map(x=>[x.lat, x.lng])); map.fitBounds(b, {padding:[24,24]}); }
    else { map.setView([42.1501,-71.7637], 12); }
  }catch(_){}
}

// --- Google Sign-In: reuse saved token if available ---
window.onload = () => {
  const saved = getSavedToken();
  if(saved){ setToken(saved); $('#me').textContent='Signed in'; refresh().then(()=>ensureMap()).then(()=>plotMap()); }

  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: (resp)=>{ setToken(resp.credential); $('#me').textContent='Signed in'; refresh().then(()=>ensureMap()).then(()=>plotMap()); }
  });
  google.accounts.id.renderButton(document.getElementById('gsi'), { theme:'outline', size:'large' });
};
</script>
</body>
</html>
