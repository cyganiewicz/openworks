<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OpenWorks — Report an Issue</title>
<style>
  :root{
    --bg:#f7f9fc; --card:#ffffff; --ink:#0e1116; --muted:#5a6a72; --border:#e6ebf2;
    --brand:#2e7d32; --brand-ink:#ffffff; --danger:#c92a2a; --focus:#0ea5e9; --badge:#f1f5f9;
    --shadow: 0 10px 30px rgba(18, 38, 63, .08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:920px;margin:0 auto;padding:28px 20px}
  header{display:flex;gap:16px;align-items:center;margin:0 0 18px}
  header img{width:56px;height:56px;object-fit:contain}
  h1{font-size:2rem;margin:.1em 0}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:20px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:760px){ .grid{grid-template-columns:1fr} }
  label{display:block;font-weight:700;margin:8px 0 6px}
  input[type="text"],input[type="email"],input[type="tel"],input[type="file"],select,textarea{
    width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff0;color:inherit;font:inherit
  }
  textarea{min-height:110px;resize:vertical}
  .hint{color:var(--muted);font-size:.95rem}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid transparent;background:var(--brand);color:var(--brand-ink);border-radius:12px;padding:12px 18px;cursor:pointer;font-weight:800}
  .btn.secondary{background:transparent;border-color:var(--border);color:var(--ink)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  details{margin:10px 0 18px}
  summary{font-weight:800;cursor:pointer}
  .status{margin-top:12px;padding:12px 14px;border-radius:12px;display:none}
  .ok{background:#e8f5e9;border:1px solid #c8e6c9}
  .err{background:#ffebee;border:1px solid #ffcdd2;color:var(--danger)}
  .files{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:8px}
  .thumb{border:1px dashed var(--border);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;background:#fff0}
  .thumb img{max-width:100%;max-height:80px;border-radius:8px}
  .toast{position:fixed;inset:auto 16px 16px auto;background:var(--card);color:var(--ink);border:1px solid var(--border);padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(8px);transition:.25s}
  .toast.show{opacity:1;transform:none}
  .badge{display:inline-flex;align-items:center;gap:6px;background:var(--badge);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:.9rem}
  :focus-visible{outline:3px solid var(--focus);outline-offset:2px;border-radius:10px}
  .successTitle{font-weight:800;margin:0 0 6px}
</style>
</head>
<body>
<div class="wrap">
  <header class="row">
    <img alt="Town of Sutton seal" src="https://upload.wikimedia.org/wikipedia/commons/2/27/Seal_of_Sutton%2C_Massachusetts.png?20231220025329" />
    <div>
      <h1>OpenWorks Sutton</h1>
      <div class="hint">Report an issue. We’ll route it to the right crew and keep you posted.</div>
    </div>
  </header>

  <details class="card" open>
    <summary>Before you report</summary>
    <ul class="hint" style="margin:8px 0 0">
      <li>Downed lines? Call 911 or your utility first.</li>
      <li>Storm after-hours: submit here; crews triage by safety first.</li>
      <li>Photos help. Add a landmark if no street number exists.</li>
    </ul>
  </details>

  <form id="f" class="card" novalidate>
    <div style="display:none"><input name="website" autocomplete="off"></div>

    <div class="grid">
      <div>
        <label>Category *</label>
        <select name="category" required>
          <option value="">Choose…</option>
          <option value="roads_sidewalks">Roads &amp; Sidewalks</option>
          <option value="trees_row">Trees &amp; Vegetation (ROW)</option>
          <option value="signs_markings">Signs &amp; Markings</option>
          <option value="drainage_stormwater">Drainage &amp; Stormwater</option>
          <option value="snow_ice">Snow &amp; Ice</option>
          <option value="litter_dumping">Litter &amp; Illegal Dumping</option>
          <option value="facilities_grounds">Facilities &amp; Grounds</option>
          <option value="sewer">Sewer (routing)</option>
        </select>
      </div>
      <div>
        <label>Subcategory (optional)</label>
        <input name="subcategory" type="text" placeholder="e.g., Pothole, Missing sign, Blocked basin" />
      </div>
    </div>

    <label>Describe the issue *</label>
    <textarea name="description" minlength="12" required placeholder="What’s happening? Include landmarks, direction of travel, etc."></textarea>

    <div class="grid">
      <div>
        <label>Street address or nearest landmark</label>
        <input name="address" type="text" placeholder="123 Main St or ‘near ballfield gate’" />
      </div>
      <div>
        <label>GPS (optional)</label>
        <div class="row">
          <input name="lat" type="text" inputmode="decimal" placeholder="lat" style="max-width:46%" />
          <input name="lng" type="text" inputmode="decimal" placeholder="lng" style="max-width:46%" />
          <button type="button" id="geo" class="btn secondary">Use my location</button>
        </div>
        <div class="hint">GPS helps pinpoint the location.</div>
      </div>
    </div>

    <div class="grid">
      <div>
        <label>Your name *</label>
        <input name="reporter_name" required />
      </div>
      <div>
        <label>Email *</label>
        <input name="reporter_email" type="email" required />
      </div>
    </div>

    <div class="grid">
      <div>
        <label>Phone (optional)</label>
        <input name="reporter_phone" type="tel" />
      </div>
      <div>
        <label>Priority</label>
        <select name="priority_hint">
          <option value="normal">Normal</option>
          <option value="high">High (safety-related)</option>
          <option value="low">Low</option>
        </select>
      </div>
    </div>

    <label>Photo(s) (optional)</label>
    <input id="files" name="photo" type="file" accept="image/*" multiple />
    <div id="previews" class="files" aria-live="polite"></div>

    <div class="hint" style="margin:12px 0 16px">
      Submissions may be a public record. Please avoid sensitive information.
    </div>

    <div class="row">
      <button class="btn" id="submit">Submit report</button>
      <button class="btn secondary" type="reset">Reset</button>
      <span id="spinner" class="badge" style="display:none">Submitting…</span>
    </div>

    <div id="ok" class="status ok" role="status" aria-hidden="true">
      <div class="successTitle">Thanks! We received your report.</div>
      <div class="hint">If you entered an email, we sent a confirmation.</div>
    </div>
    <div id="err" class="status err" role="alert" aria-hidden="true"></div>
  </form>

  <footer class="hint" style="margin:18px 4px">
    Town of Sutton • 4 Uxbridge Road, Sutton, MA 01590 • (508) 917-7000
    <span style="margin-left:12px"><a href="/admin/" class="hint">Staff login</a></span>
  </footer>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbwgL8hpjAivoSEvDYE61lrLbw8FkBKcylJZxK-e17456wFFDWsaKhqxkFXQzCioujA/exec';

function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2800); }

const previews = document.getElementById('previews');
document.getElementById('files').addEventListener('change', (e)=>{
  previews.innerHTML = '';
  const files = Array.from(e.target.files||[]);
  if(files.length>6){ toast('Please limit to 6 photos.'); e.target.value=''; return; }
  files.forEach(f=>{
    if(f.size>4*1024*1024){ toast(`"${f.name}" is over 4MB.`); }
    const div=document.createElement('div'); div.className='thumb';
    if(f.type.startsWith('image/')){ const img=document.createElement('img'); img.alt=f.name; div.appendChild(img); const r=new FileReader(); r.onload=()=>{img.src=r.result}; r.readAsDataURL(f); }
    const cap=document.createElement('div'); cap.textContent=f.name; cap.className='hint'; div.appendChild(cap);
    previews.appendChild(div);
  });
});

document.getElementById('geo').addEventListener('click', ()=>{
  if(!navigator.geolocation){ toast('Geolocation not supported'); return; }
  const btn = document.getElementById('geo'); btn.disabled = true;
  navigator.geolocation.getCurrentPosition(
    pos => {
      document.querySelector('[name=lat]').value = pos.coords.latitude.toFixed(6);
      document.querySelector('[name=lng]').value = pos.coords.longitude.toFixed(6);
      btn.disabled = false; toast('Location added');
    },
    err => { toast('Could not get location: '+err.message); btn.disabled = false; },
    {enableHighAccuracy:true, timeout:10000, maximumAge:0}
  );
});

document.getElementById('f').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const form = e.currentTarget;
  const ok = document.getElementById('ok');
  const err = document.getElementById('err');
  const spin = document.getElementById('spinner');
  ok.style.display='none'; ok.setAttribute('aria-hidden','true');
  err.style.display='none'; err.setAttribute('aria-hidden','true');

  const fd = new FormData(form);
  if(fd.get('website')) return; // honeypot
  if(!fd.get('category') || !fd.get('description') || !fd.get('reporter_name') || !fd.get('reporter_email')){
    err.textContent='Please complete the required fields (Category, Description, Name, Email).';
    err.style.display='block'; err.removeAttribute('aria-hidden'); return;
  }

  const payload = Object.fromEntries(fd.entries());
  payload.reporter_phone = (payload.reporter_phone || '').replace(/[^\d+]/g,'');

  const files = Array.from(document.getElementById('files').files || []);
  if(files.length){
    payload.photos = await Promise.all(files.slice(0,6).map(f => new Promise((resolve,reject)=>{
      const r=new FileReader(); r.onload=()=>resolve({name:f.name,type:f.type,data:String(r.result).split(',')[1]||''}); r.onerror=reject; r.readAsDataURL(f);
    })));
  }

  spin.style.display='inline-flex';
  try{
    const res = await fetch(API, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain' }, // simple request, no preflight
      body: JSON.stringify({ action:'submit', payload })
    });
    const data = await res.json();
    spin.style.display='none';
    if(data.ok){
      ok.innerHTML = `<div class="successTitle">Thanks! Ticket ${data.id || ''} received.</div><div class="hint">We emailed you a confirmation.</div>`;
      ok.style.display='block'; ok.removeAttribute('aria-hidden');
      const cat = payload.category;
      form.reset();
      document.querySelector('[name=category]').value = cat;
      previews.innerHTML='';
      toast('Submitted ✓');
    }else{
      err.textContent = data.error || 'Submission failed. Please try again.';
      err.style.display='block'; err.removeAttribute('aria-hidden');
    }
  }catch(ex){
    spin.style.display='none';
    err.textContent='Network error. Please try again.'; err.style.display='block'; err.removeAttribute('aria-hidden');
  }
});
</script>
</body>
</html>
