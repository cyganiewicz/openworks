<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OpenWorks Sutton</title>
<link rel="stylesheet" href="openworks.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
<header class="nav">
  <div class="wrap nav__inner">
    <div class="nav__brand">
      <img src="../assets/logo.png" onerror="this.style.display='none'" alt="">
      <div><div class="tag">Town of Sutton</div><h1>OpenWorks Sutton</h1></div>
    </div>
    <nav class="nav__links"><a class="btn btn--ghost" href="admin.html">Staff Admin</a></nav>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h2 class="mt-0">Report an Issue</h2>
    <form id="f" class="grid">
      <label>Full Name<input name="name" required></label>
      <label>Email<input name="email" type="email" required></label>
      <label>Phone<input name="phone" type="tel"></label>
      <label class="span-2">Location / Address<input name="location" placeholder="123 Main St" required></label>
      <label>Issue Type
        <select name="category" required>
          <option>Pothole</option><option>Tree Removal</option><option>Streetlight</option>
          <option>Trash</option><option>Facilities</option><option>Sewer</option><option>Other</option>
        </select></label>
      <label>Priority
        <select name="priority"><option>Normal</option><option>Low</option><option>High</option><option>Urgent</option></select></label>
      <label class="span-2">Description<textarea name="description" rows="3" required></textarea></label>
      <div class="span-2">
        <div class="muted">Click the map to set exact location (optional).</div>
        <div id="pickMap" class="map"></div>
        <input type="hidden" name="lat"><input type="hidden" name="lng">
      </div>
      <label class="span-2">Optional Photo
        <input id="photo" type="file" accept="image/*">
        <div class="hint">Photo will be stored under the ticket’s folder in Drive.</div>
      </label>
      <div class="actions span-2">
        <button class="btn" type="submit">Submit Request</button>
        <span id="msg" class="muted"></span>
      </div>
    </form>
  </section>

  <section class="card">
    <div class="flex between center">
      <h2 class="mt-0">Recent Requests</h2>
      <div class="filters">
        <select id="status"><option value="">All</option><option>New</option><option>In Progress</option><option>Completed</option><option>Closed</option></select>
        <select id="cat"><option value="">All Types</option><option>Pothole</option><option>Tree Removal</option><option>Streetlight</option><option>Trash</option><option>Facilities</option><option>Sewer</option><option>Other</option></select>
      </div>
    </div>
    <div id="pubMap" class="map"></div>
  </section>
</main>

<footer class="footer"><div class="wrap">© Town of Sutton • OpenWorks</div></footer>

<script>
const PUBLIC_API = 'https://script.google.com/macros/s/AKfycbyAgYmATzzTO1LiTeCRUQMHkXoHSjkFBdnubVsdrrAxVRfij9qHGMHfsdZ7AhtOGSOw1A/exec'; // ends with /exec

// ---- Helper: safe file -> data URL (prevents call stack overflow) ----
function fileToDataURL(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);  // already "data:*;base64,...."
    r.onerror = () => reject(r.error || new Error('File read failed'));
    r.readAsDataURL(file);
  });
}

// Leaflet picker
let pick = L.map('pickMap').setView([42.1501,-71.7620], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(pick);
let pMarker=null;
pick.on('click',(e)=>{ if(pMarker) pick.removeLayer(pMarker); pMarker=L.marker(e.latlng).addTo(pick);
  document.querySelector('input[name=lat]').value=e.latlng.lat;
  document.querySelector('input[name=lng]').value=e.latlng.lng; });

// Submit
const form=document.getElementById('f'), msg=document.getElementById('msg');
form.addEventListener('submit', async (e)=>{
  e.preventDefault(); msg.textContent='Submitting…';
  try{
    const fd = new FormData(form);

    // optional size guard (8 MB)
    const file=document.getElementById('photo').files[0];
    if (file && file.size > 8 * 1024 * 1024) {
      msg.textContent = 'Please choose a photo under 8 MB.';
      return;
    }

    let photoDataUrl = '';
    if (file){
      // Use FileReader to avoid stack overflow
      photoDataUrl = await fileToDataURL(file);
    }

    const payload = {
      action:'create_ticket',
      data:{
        status:'New',
        priority:fd.get('priority')||'Normal',
        category:fd.get('category'),
        title:(fd.get('category')||'Issue') + ' — ' + (fd.get('location')||''),
        description:fd.get('description'),
        location:fd.get('location'),
        lat:fd.get('lat')||'',
        lng:fd.get('lng')||'',
        name:fd.get('name'),
        email:fd.get('email'),
        phone:fd.get('phone'),
        photoDataUrl
      }
    };
    const res=await fetch(PUBLIC_API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    const json=await res.json();
    if (json.error) throw new Error(json.error);
    msg.textContent=`Thanks! Your ticket is ${json.ticket}.`;
    form.reset(); if(pMarker){ pick.removeLayer(pMarker); pMarker=null; }
    loadPublic();
  }catch(err){ console.error(err); msg.textContent='Error: '+err.message; }
});

// Public map
let pub=L.map('pubMap').setView([42.1501,-71.7620], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(pub);
let layer=L.layerGroup().addTo(pub);
function color(s){ return ({'New':'red','In Progress':'orange','Completed':'green','Closed':'blue'})[s]||'purple'; }
async function loadPublic(){
  const url=new URL(PUBLIC_API); url.searchParams.set('action','list_public');
  const res=await fetch(url); const json=await res.json(); const s=document.getElementById('status').value; const c=document.getElementById('cat').value;
  const items=(json.items||[]).filter(r=>(!s||r.status===s)&&(!c||r.category===c));
  layer.clearLayers();
  items.filter(r=>r.lat&&r.lng).forEach(r=>{
    const m=L.circleMarker([r.lat,r.lng],{radius:8,color:color(r.status)});
    m.bindPopup(`<b>${r.title||'Issue'}</b><br>${r.category} • ${r.status}<br>${r.location||''}`);
    layer.addLayer(m);
  });
}
document.getElementById('status').onchange=loadPublic;
document.getElementById('cat').onchange=loadPublic;
loadPublic();
</script>
</body>
</html>
