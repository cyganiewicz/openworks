<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OpenWorks Admin</title>
<link rel="stylesheet" href="openworks.css">
</head>
<body>
<header class="nav">
  <div class="wrap nav__inner">
    <div class="nav__brand">
      <img src="../assets/logo.png" onerror="this.style.display='none'" alt="">
      <div><div class="tag">Town of Sutton</div><h1>OpenWorks Admin</h1></div>
    </div>
    <nav class="nav__links"><a href="index.html">Public</a></nav>
  </div>
</header>

<main class="wrap admin__grid" style="margin-top:16px">
  <section class="card">
    <div class="toolbar">
      <input id="q" placeholder="Search…" style="min-width:220px;">
      <select id="st"><option value="">All</option><option>New</option><option>In Progress</option><option>Completed</option><option>Closed</option></select>
      <button id="refresh" class="btn">Refresh</button>
      <span id="count" class="muted" style="margin-left:auto"></span>
    </div>
    <div style="overflow:auto">
      <table class="table" id="tbl">
        <thead><tr><th>Ticket</th><th>Status</th><th>Category</th><th>Title</th><th>Location</th><th>Assigned</th><th>Updated</th></tr></thead>
        <tbody id="rows"><tr><td class="muted" colspan="7">Loading…</td></tr></tbody>
      </table>
    </div>
  </section>

  <aside class="card">
    <h3 class="mt-0">Details</h3>
    <div id="empty" class="muted">Select a ticket to edit.</div>
    <div id="edit" class="hidden">
      <div class="editor__field"><span class="editor__label">Ticket</span><div id="e_ticket" class="pill"></div></div>
      <div class="editor__row">
        <div class="editor__field"><label class="editor__label">Status</label>
          <select id="e_status"><option>New</option><option>In Progress</option><option>Completed</option><option>Closed</option></select></div>
        <div class="editor__field"><label class="editor__label">Priority</label>
          <select id="e_priority"><option>Normal</option><option>Low</option><option>High</option><option>Urgent</option></select></div>
      </div>
      <div class="editor__row">
        <div class="editor__field"><label class="editor__label">Assigned To</label><input id="e_assigned" placeholder="name@town.sutton.ma.us"></div>
        <div class="editor__field"><label class="editor__label">Department</label><input id="e_dept" placeholder="Highway / Sewer / Facilities …"></div>
      </div>
      <div class="editor__field"><label class="editor__label">Title</label><input id="e_title"></div>
      <div class="editor__field"><label class="editor__label">Description</label><textarea id="e_desc"></textarea></div>
      <div class="editor__field"><label class="editor__label">Add Note</label><textarea id="e_notes" placeholder="This note is appended to the ticket’s log."></textarea></div>
      <div class="actions"><button id="save" class="btn">Save</button><button id="addNote" class="btn btn--outline">Add Note</button><span id="msg" class="muted"></span></div>

      <hr style="margin:14px 0">

      <div class="editor__field">
        <label class="editor__label">Upload After Photo(s)</label>
        <input id="afterFile" type="file" accept="image/*" multiple>
        <div class="hint">Photos are stored in Drive under the ticket folder → <code>after/</code>.</div>
        <div id="afterMsg" class="muted mt-8"></div>
      </div>

      <div class="editor__field">
        <label class="editor__label">Notes Log (CompletionNotes)</label>
        <div id="log" class="muted">—</div>
      </div>
    </div>
  </aside>
</main>

<footer class="footer"><div class="wrap">© Town of Sutton • OpenWorks Admin</div></footer>

<script>
const ADMIN_API = 'https://script.google.com/a/macros/town.sutton.ma.us/s/AKfycbzcfSJjt_yrQvLytZAWTqGESQ2PfYpdmmjPhzEP0kTqpwRtv-3jLUz5HrmccDaN9E_KNQ/exec'; // ends with /exec

// ---- Helper: safe file -> data URL (prevents call stack overflow) ----
function fileToDataURL(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);   // already "data:*;base64,...."
    r.onerror = () => reject(r.error || new Error('File read failed'));
    r.readAsDataURL(file);
  });
}

async function apiGet(action){
  const url=new URL(ADMIN_API); url.searchParams.set('action',action);
  const res=await fetch(url); return res.json();
}
async function apiPost(action,data){
  const res=await fetch(ADMIN_API,{method:'POST',headers: { 'Content-Type': 'text/plain' },body:JSON.stringify({action,data})});
  return res.json();
}
function fmtDate(s){ try{ return new Date(s).toLocaleString(); }catch(e){ return s||''; } }

let all=[], current=null;

async function load(){
  const json=await apiGet('list_admin');
  const tbody=document.getElementById('rows');
  if (json.error){ tbody.innerHTML=`<tr><td colspan="7" class="muted">${json.error}</td></tr>`; return; }
  all=json.items||[];
  const st=document.getElementById('st').value; const q=(document.getElementById('q').value||'').toLowerCase();
  const filt=all.filter(r=>!st||String(r.Status)===st)
                .filter(r=>!q || String(r.Ticket).toLowerCase().includes(q) ||
                              String(r.Location||'').toLowerCase().includes(q) ||
                              String(r.Description||'').toLowerCase().includes(q) ||
                              String(r.Title||'').toLowerCase().includes(q));
  document.getElementById('count').textContent = `${filt.length} tickets`;
  tbody.innerHTML='';
  if (!filt.length){ tbody.innerHTML='<tr><td colspan="7" class="muted">No matches.</td></tr>'; return; }
  filt.sort((a,b)=> new Date(b.UpdatedAt||b.OpenedAt||0) - new Date(a.UpdatedAt||a.OpenedAt||0));
  for (const r of filt){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><a href="#" data-id="${r.Ticket}">${r.Ticket}</a></td>
      <td><span class="status-badge">${r.Status||''}</span></td>
      <td>${r.Category||''}</td><td>${r.Title||''}</td><td>${r.Location||''}</td>
      <td>${r.AssignedTo||''}</td><td>${fmtDate(r.UpdatedAt||r.OpenedAt)}</td>`;
    tr.querySelector('a').onclick=(e)=>{ e.preventDefault(); openTicket(r); };
    tbody.appendChild(tr);
  }
}
function openTicket(r){
  current=r;
  document.getElementById('empty').classList.add('hidden');
  document.getElementById('edit').classList.remove('hidden');
  document.getElementById('e_ticket').textContent=r.Ticket;
  document.getElementById('e_status').value=r.Status||'New';
  document.getElementById('e_priority').value=r.Priority||'Normal';
  document.getElementById('e_assigned').value=r.AssignedTo||'';
  document.getElementById('e_dept').value=r.Department||'';
  document.getElementById('e_title').value=r.Title||'';
  document.getElementById('e_desc').value=r.Description||'';
  document.getElementById('e_notes').value='';
  document.getElementById('log').textContent=r.CompletionNotes||'—';
  document.getElementById('afterMsg').textContent='';
}
async function save(){
  if (!current) return;
  const updates={
    Status:document.getElementById('e_status').value,
    Priority:document.getElementById('e_priority').value,
    AssignedTo:document.getElementById('e_assigned').value,
    Department:document.getElementById('e_dept').value,
    Title:document.getElementById('e_title').value,
    Description:document.getElementById('e_desc').value
  };
  const json=await apiPost('update_ticket',{ticket:current.Ticket,updates});
  document.getElementById('msg').textContent=json.error?json.error:'Saved.';
  if (!json.error) load();
}
async function addNote(){
  if (!current) return;
  const body=(document.getElementById('e_notes').value||'').trim();
  if (!body) return;
  const json=await apiPost('add_note',{ticket:current.Ticket,note:body});
  document.getElementById('msg').textContent=json.error?json.error:'Note added.';
  if (!json.error) load();
}
document.getElementById('refresh').onclick=load;
document.getElementById('st').onchange=load;
document.getElementById('q').oninput=()=>{ clearTimeout(window._t); window._t=setTimeout(load,250); };
document.getElementById('save').onclick=save;
document.getElementById('addNote').onclick=addNote;

document.getElementById('afterFile').addEventListener('change', async (e)=>{
  if (!current) return;
  const files=[...e.target.files];
  if (!files.length) return;
  document.getElementById('afterMsg').textContent='Uploading…';
  try{
    for (const f of files){
      // optional size guard (8 MB per file)
      if (f.size > 8 * 1024 * 1024) {
        throw new Error(`"${f.name}" is larger than 8 MB`);
      }
      // Use FileReader to avoid stack overflow
      const photoDataUrl = await fileToDataURL(f);
      const res=await apiPost('add_photo_after',{ticket:current.Ticket,photoDataUrl});
      if (res.error) throw new Error(res.error);
    }
    document.getElementById('afterMsg').textContent='Upload complete.';
    load();
  }catch(err){
    document.getElementById('afterMsg').textContent='Error: '+err.message;
  }finally{
    e.target.value='';
  }
});

load();
</script>
</body>
</html>
